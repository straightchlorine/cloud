#!/bin/bash
# Music import script using Beets

set -e

MUSIC_STACK_HOME="{{ music_stack_home }}"
LOG_FILE="$MUSIC_STACK_HOME/logs/import.log"
PROCESSING_DIR="{{ music_library_path }}/processing"
DOWNLOADS_DIR="{{ music_library_path }}/downloads"

echo "$(date): Starting music import..." >> "$LOG_FILE"

# Start beets container if not running
if ! docker ps | grep -q "beets"; then
    echo "$(date): Starting beets container..." >> "$LOG_FILE"
    cd "$MUSIC_STACK_HOME"
    docker compose --profile tools up -d beets
fi

# Process files in downloads directory
if [ -d "$DOWNLOADS_DIR" ] && [ "$(ls -A "$DOWNLOADS_DIR")" ]; then
    echo "$(date): Processing files from downloads directory..." >> "$LOG_FILE"
    
    # Move files to processing directory
    mv "$DOWNLOADS_DIR"/* "$PROCESSING_DIR/" 2>/dev/null || true
fi

# Process files in processing directory
if [ -d "$PROCESSING_DIR" ] && [ "$(ls -A "$PROCESSING_DIR")" ]; then
    echo "$(date): Running beets import..." >> "$LOG_FILE"
    
    # Run beets import
    docker exec -it beets beet import /processing \
        >> "$LOG_FILE" 2>&1 || echo "$(date): Beets import had issues, check log" >> "$LOG_FILE"
else
    echo "$(date): No files to process" >> "$LOG_FILE"
fi

echo "$(date): Music import completed" >> "$LOG_FILE"