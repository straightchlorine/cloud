services:
  traefik:
    image: traefik:v3.0
    container_name: traefik
    restart: unless-stopped
    ports:
      - "{{ traefik_web_port }}:80"
      - "{{ traefik_websecure_port }}:443"
      - "192.168.20.20:{{ traefik_dashboard_port }}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/traefik:/config:ro
      - {{ automation_data_path }}/traefik:/data
      - ./logs:/logs
    environment:
      - TRAEFIK_API_DASHBOARD=true
      - TRAEFIK_API_INSECURE=true
      - CF_DNS_API_TOKEN={{ vault_cloudflare_api_token | default('') }}
    command:
      - --configFile=/config/traefik.yml
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dashboard.rule=Host(`{{ subdomain_traefik }}.{{ domain_name }}`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=letsencrypt"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.middlewares=dashboard-auth"
      - "traefik.http.middlewares.dashboard-auth.basicauth.users={{ vault_traefik_basic_auth }}"

  influxdb3-core:
    image: influxdb:3-core
    container_name: influxdb3-core
    restart: unless-stopped
    user: "1000:1000"
    ports:
      - "8181:8181"
    command:
      - influxdb3
      - serve
      - --node-id=node0
      - --object-store=file
      - --data-dir=/var/lib/influxdb3/data
      - --plugin-dir=/var/lib/influxdb3/plugins
    volumes:
      - {{ automation_data_path }}/influxdb3/data:/var/lib/influxdb3/data
      - {{ automation_data_path }}/influxdb3/plugins:/var/lib/influxdb3/plugins
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.influxdb.rule=Host(`{{ subdomain_influxdb }}.{{ domain_name }}`)"
      - "traefik.http.routers.influxdb.entrypoints=websecure"
      - "traefik.http.routers.influxdb.tls.certresolver=letsencrypt"
      # InfluxDB 3 listens on 8181; update Traefik service port accordingly:
      - "traefik.http.services.influxdb.loadbalancer.server.port=8181"

  influxdb3-explorer:
    image: influxdata/influxdb3-ui:1.2.0
    container_name: influxdb3-explorer
    restart: unless-stopped
    # Admin mode for full functionality; omit command for read-only (query) mode
    command: ["--mode=admin"]
    ports:
      - "8888:80"
    environment:
      # persist sessions across restarts (set a strong value in prod)
      SESSION_SECRET_KEY: ${SESSION_SECRET_KEY:-changeme123456789012345678901234}
    volumes:
      # persist UI state (recommended)
      - {{ automation_data_path }}/influxdb3-explorer:/db:rw
      # optional: preconfigure connection (see config.json example below)
      - ./config/influxdb3-explorer:/app-root/config:ro
      # optional: enable HTTPS by mounting certs and publishing 443 instead of 80
      # - ./ssl:/etc/nginx/ssl:ro
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.influxdb-explorer.rule=Host(`{{ subdomain_explorer }}.{{ domain_name }}`)"
      - "traefik.http.routers.influxdb-explorer.entrypoints=websecure"
      - "traefik.http.routers.influxdb-explorer.tls.certresolver=letsencrypt"
      - "traefik.http.services.influxdb-explorer.loadbalancer.server.port=80"

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    volumes:
      - {{ automation_data_path }}/vaultwarden:/data
    environment:
      - DOMAIN=https://{{ subdomain_vaultwarden }}.{{ domain_name }}
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vaultwarden.rule=Host(`{{ subdomain_vaultwarden }}.{{ domain_name }}`)"
      - "traefik.http.routers.vaultwarden.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden.tls.certresolver=letsencrypt"
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"
      - "traefik.http.routers.vaultwarden-websocket.rule=Host(`{{ subdomain_vaultwarden }}.{{ domain_name }}`) && Path(`/notifications/hub`)"
      - "traefik.http.routers.vaultwarden-websocket.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden-websocket.tls.certresolver=letsencrypt"
      - "traefik.http.routers.vaultwarden-websocket.service=vaultwarden-websocket"
      - "traefik.http.services.vaultwarden-websocket.loadbalancer.server.port=3012"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    ports:
      - "8084:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.watchtower.rule=Host(`{{ subdomain_watchtower }}.{{ domain_name }}`)"
      - "traefik.http.routers.watchtower.entrypoints=websecure"
      - "traefik.http.routers.watchtower.tls.certresolver=letsencrypt"
      - "traefik.http.services.watchtower.loadbalancer.server.port=8080"
      - "traefik.http.routers.watchtower.middlewares=watchtower-auth"
      - "traefik.http.middlewares.watchtower-auth.basicauth.users={{ vault_watchtower_basic_auth }}"

  dozzle:
    image: amir20/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./config/dozzle:/data
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dozzle.rule=Host(`{{ subdomain_dozzle }}.{{ domain_name }}`)"
      - "traefik.http.routers.dozzle.entrypoints=websecure"
      - "traefik.http.routers.dozzle.tls.certresolver=letsencrypt"
      - "traefik.http.services.dozzle.loadbalancer.server.port=8080"

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - {{ automation_data_path }}/portainer:/data
    networks:
      - traefik-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`{{ subdomain_portainer }}.{{ domain_name }}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=letsencrypt"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

networks:
  traefik-network:
    external: true

volumes:
  traefik-data:
    driver: local
    driver_opts:
      o: bind
      type: none
      device: {{ automation_data_path }}/traefik
