#!/bin/bash

BACKUP_DIR="{{ automation_data_path }}/backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="automation_backup_$TIMESTAMP.tar.gz"
AUTOMATION_HOME="{{ automation_stack_home }}"
DATA_PATH="{{ automation_data_path }}"

echo "Starting automation stack backup at $(date)"

echo "Stopping services..."
cd "$AUTOMATION_HOME"
docker compose stop

echo "Creating backup archive..."
tar -czf "$BACKUP_DIR/$BACKUP_FILE" \
    --exclude="$DATA_PATH/backups" \
    -C / \
    "$(echo $DATA_PATH | sed 's|^/||')" \
    "$(echo $AUTOMATION_HOME | sed 's|^/||')"

echo "Starting services..."
docker compose up -d

chown {{ ansible_user }}:{{ ansible_user }} "$BACKUP_DIR"/*

echo "Backup completed successfully!"
echo "Files created: $BACKUP_DIR/$BACKUP_FILE"

echo "Backup directory usage:"
du -sh "$BACKUP_DIR"